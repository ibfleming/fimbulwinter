name: Check Mod Updates

on:
  schedule:
    # Every Monday at 09:00 UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

jobs:
  check-updates:
    name: Check Thunderstore Updates
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install jq
        run: sudo apt-get install -q -y jq

      - name: Run Update Checker
        id: check
        run: |
          chmod +x .github/workflows/update-mods.sh
          .github/workflows/update-mods.sh thunderstore.toml

      - name: Create or Update Issue
        if: steps.check.outputs.updates_available != '0' && steps.check.outputs.updates_available != ''
        uses: actions/github-script@v7
        with:
          script: |
            const updates = JSON.parse('${{ steps.check.outputs.update_list }}');
            const count = updates.length;

            const title = `⬆️ ${count} Thunderstore mod update(s) available`;

            let body = `## Thunderstore Mod Updates\n\n`;
            body += `The weekly update check found **${count}** mod(s) with newer versions on Thunderstore.\n\n`;
            body += `| Mod | Current | Latest |\n`;
            body += `|-----|---------|--------|\n`;
            for (const u of updates) {
              body += `| \`${u.mod}\` | ${u.current} | **${u.latest}** |\n`;
            }
            body += `\n### Next Steps\n\n`;
            body += `1. Review the [Thunderstore changelogs](https://thunderstore.io/c/valheim/) for breaking changes\n`;
            body += `2. Update versions in \`thunderstore.toml\`\n`;
            body += `3. Install via r2modman, run the game, check for new configs\n`;
            body += `4. Update \`modpack/config/\` if needed\n`;
            body += `5. Update CHANGELOG.md, README.md, PROJECT.md\n\n`;
            body += `*Auto-generated by [check-updates workflow](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})*`;

            // Find existing open issue with same title pattern
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'mod-updates',
              per_page: 10
            });

            const existing = issues.find(i => i.title.includes('Thunderstore mod update'));

            if (existing) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                title,
                body
              });
              console.log(`Updated existing issue #${existing.number}`);
            } else {
              const { data: created } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['mod-updates']
              });
              console.log(`Created issue #${created.number}`);
            }
